<ion-content class="tp-map-page" fullscreen scroll-y="false">
  <!-- Full screen interactive map -->
  <div class="tp-map-page__map" data-testid="leaflet-map-canvas">
    <app-tourism-leaflet-map [pois]="vm().pois" [selectedPoiId]="vm().selectedPoi?.id ?? null"
      (poiSelect)="onSelectPoi($event)" (boundsChange)="onBoundsChange($event)" />
  </div>

  <!-- Top Toolbar Overlay -->
  <app-tourism-map-toolbar *ngIf="!isOffline && !vm().error" [loading]="vm().loading"
    [selectedCategory]="selectedCategory" (search)="onSearch($event)" (categorySelect)="onCategorySelect($event)" />

  <!-- Offline / Error Banners -->
  <div class="tp-map-page__offline-header" *ngIf="isOffline || vm().error">
    <div class="tp-map-page__header-title">Explorar</div>
    <app-tourism-offline-banner *ngIf="isOffline" />
  </div>

  <div class="tp-map-page__content-states" *ngIf="isOffline || vm().error || vm().loading">
    <app-tourism-empty-state *ngIf="vm().error && !isOffline" (retry)="store.loadPois({ limit: 100, city: 'Spain' })" />

    <app-tourism-saved-list *ngIf="isOffline" [savedPois]="vm().pois" />

    <app-tourism-skeleton-loader *ngIf="vm().loading" />
  </div>

  <!-- Right Map Controls Overlay -->
  <div class="tp-map-page__controls" *ngIf="!isOffline && !vm().error">
    <button class="tp-map-page__fab-mini">
      <span class="material-symbols-outlined">my_location</span>
    </button>
    <button class="tp-map-page__fab-mini">
      <span class="material-symbols-outlined">layers</span>
    </button>
  </div>

  <!-- Bottom Interactive Area -->
  <div class="tp-map-page__bottom-area">
    <div class="tp-map-page__plan-route-wrapper">
      <button class="tp-map-page__fab-main" (click)="onOpenRoutePlanner()">
        <span class="material-symbols-outlined">alt_route</span>
        <span class="tp-map-page__fab-main-text">Plan Route</span>
      </button>
    </div>

    <!-- POI Carousel -->
    <app-tourism-poi-list [pois]="vm().pois" [selectedPoiId]="vm().selectedPoi?.id ?? null"
      (selectPoi)="onSelectPoi($event)" />
  </div>

  <!-- Main Bottom Nav Overlay -->
  <app-tourism-bottom-nav *ngIf="!isRoutingMode" />

  <!-- POI Detail Modal (Drawer) -->
  <ion-modal [isOpen]="!!vm().selectedPoi" [initialBreakpoint]="1" [breakpoints]="[0, 1]" style="--height: 90vh;"
    (didDismiss)="onClosePoiDetail()">
    <ng-template>
      <app-tourism-poi-detail *ngIf="vm().selectedPoi as poi" [poi]="poi" (close)="onClosePoiDetail()"
        (getDirections)="onGetDirections(poi)" />
    </ng-template>
  </ion-modal>

  <!-- Route Planner Modal (Fullscreen Screen) -->
  <ion-modal [isOpen]="isRoutingMode" (didDismiss)="onCloseRoutePlanner()">
    <ng-template>
      <app-tourism-route-planner [route]="vm().route" (close)="onCloseRoutePlanner()"
        (calculateRoute)="onCalculateRoute($event)" />
    </ng-template>
  </ion-modal>
</ion-content>